<html>
  <head>
    <script src="https://apis.google.com/js/client.js"></script>
      <meta charset="utf-8">
  <title>jQuery UI Accordion - Default functionality</title>
  <link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
  <script src="//code.jquery.com/jquery-1.10.2.js"></script>
  <script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
  <link rel="stylesheet" type="text/css" href="gmailExample.css">
  </head>

  <body>
 
	<form>
	Target:<br>
	<input type="text" name="firstname">
	<br>
	Message:<br>
	<input type="text" name="lastname" size = "100" height: "100">
	</form> 
	<button onclick="sendMessage()"> send </button>
	 
  	<div id = "hiddenFlag"><!-- style="visibility: hidden">--></div>  	
  	<div id= "content"></div>
		<div class="transbox">
			<img src="MailGood.png" style="width:70px;height:45px; display: inline">
			<h3 id = "emailTitle" style="align: left; display: inline"> </h3>

			<p id = "emailBody"></p>	
		</div>
  </body>

   <!--Add a button for the user to click to initiate auth sequence -->
    <button id="authorize-button" style="visibility: hidden">Authorize</button>
    <button id="Logout-button" onclick = "window.location = 'https://mail.google.com/mail/u/0/?logout&hl=en';">log-out</button>
       
    <script type="text/javascript">
        		var j = 0;
        		var size = 0;
	var messageProcessed = 0;
	//localhost:8080
     var clientId = '688997813097-slfbf24164p8vlg1rbmebebl2nmiare7.apps.googleusercontent.com';
     	//localhost
	  //var clientId = '470903586983-24dm43r555muk55qea38njkrvteev1fl.apps.googleusercontent.com';

	//localhost:8080
      var apiKey = 'AIzaSyA5JHDmzCp3KcXWDzpIjZNgefLVzymxPSo';
      	//localhost
      //var apiKey = 'AIzaSyAhoEOtA9eRECSbPAnYAfdjgADMlGa5N3A';


      //var scopes = 'https://www.googleapis.com/auth/plus.me';
	  var scopes = 'https://mail.google.com/';

      function handleClientLoad() {
        // Step 2: Reference the API key
        gapi.client.setApiKey(apiKey);
        window.setTimeout(checkAuth,1);
      }

		function logOut(){
			gapi.auth.setToken('');//.execute(function(){location.reload()});			
		}

      function checkAuth() {
        gapi.auth.authorize({client_id: clientId, scope: scopes, immediate: true}, handleAuthResult);
      }

      function handleAuthResult(authResult) {
        var authorizeButton = document.getElementById('authorize-button');
        	//if the auth is successfull hide the button
        if (authResult && !authResult.error) {
          authorizeButton.style.visibility = 'hidden';
          makeApiCall();
          //if fail show the button
        } else {
          authorizeButton.style.visibility = '';
          authorizeButton.onclick = handleAuthClick;
        }
      }

      function handleAuthClick(event) {
        // Step 3: get authorization to use private data
        gapi.auth.authorize({client_id: clientId, scope: scopes, immediate: false}, handleAuthResult);
        return false;
      }

      // Load the API and make an API call.  Display the results on the screen.
              		var FLAGS = 0;

	  function deleteMessage(messageID){
	        		 gapi.client.gmail.users.messages.delete({
	        	            'userId': 'me',
	        	            'id' : messageID
	       			 });
	}


	function sendMessage(){
		gapi.client.load('gmail', 'v1').then(function() {
		var to = 'hehebandit@gmail.com',
        subject = 'Hello World',
        content = 'send a Gmail.'

  		var email = "From: 'me'\r\n"+
        "To:  "+ to +"\r\n"+
        "Subject: "+subject+"\r\n"+
        "\r\n"+
        content;
		
			
		var message = email;
		
        var base64EncodedEmail = btoa(message).replace(/\//g,'_').replace(/\+/g,'-');
  		var request = gapi.client.gmail.users.messages.send({
        'userId': 'me',
        'message': {
            'raw': base64EncodedEmail
        }
	    }).execute(function(resp){location.reload()});
        
      });
		
		
	}
	
      function makeApiCall() {
        // Step 4: Load the Google+ API
        var bodyArr = [];
        var fromArr = [];
       	var dateArr = [];
       	var snippetArr = [];
       	var emailFeed = [];      	
        gapi.client.load('gmail', 'v1').then(function() {

        gapi.client.gmail.users.getProfile({
            'userId': 'me'
        }).execute(function(resp){ 
        		console.log(resp);
        	
        	} 
        ); 
        	
        gapi.client.gmail.users.messages.list({
        	            'userId': 'me'
        }).execute(function(resp){ 
        		//console.log(resp);
        		var total = 5;
        		var j = 0;
				while(size < 5 && j < (resp['messages'].length-2) ){
	        		 gapi.client.gmail.users.messages.get({
	        	            'userId': 'me',
	        	            'id' : resp['messages'][j]['id']
	       			 }).execute(function(resp2){
		       			 	//console.log(resp['messages'][j]['id']); 
		        			if(resp2['payload']['parts'] === undefined){

		        			}
		        			else{
		        			var body = resp2['payload']['parts'][0]['body']['data'];
		        			//body = window.atob(body.replace(/\s/g, ''));
		        			body = decode64(body);

		        			//body = window.atob( unescape( encodeURIComponent( body ) ) );
		        			var snippet = resp2['snippet'];
		        			var header = resp2['payload']['headers'];
							var headerLength = header.length;
								
								if(headerLength >= 13){

				        			var date = resp2['payload']['headers'][4]['value'];
				        			var from = resp2['payload']['headers'][13]['value'];
									
									
									var content_html = document.createTextNode(body);
									var snippet_html = document.createTextNode(snippet);
									var deleteZXC = document.createTextNode("delete");       
									var header = document.createElement("h3");
									var p	   = document.createElement("p");
									var btn = document.createElement("BUTTON");
									var temp = resp2['id'];
	
									btn.onclick = function(){
											 gapi.client.gmail.users.messages.delete({
		        	            			'userId': 'me',
		        	            			'id' : temp
		       								 }).execute(function(resp){
		       								 	location.reload();
		       								 });
	
									};
									/*
									header.appendChild(snippet_html);
									p.appendChild(content_html);
									btn.appendChild(deleteZXC);
									//btn.setAttribute("onclick", "deleteMessage(temp);");
							
									var d = document.getElementById("content");																
									d.appendChild(header);
									d.appendChild(p);
									d.appendChild(btn);							
									*/
									console.log(body);
							        console.log(snippet);
				        			console.log(from);
				        			date = date.split(';')[1];
				        			console.log(date);
				        			date = new Date(date);
									var tempObject = {
										'body' : body,
										'from' : from,
										'snippet' : snippet,
										'date' : date									
									};
									emailFeed.push(tempObject);
									console.log(emailFeed.length);
									if(emailFeed.length > 70 && messageProcessed == 0){
										processData(emailFeed);
							      		messageProcessed =1;
									}
								} //endif header
								else{}
								j = j+1;								


							}			
	        		} //promise close inside
        			);

        	
        			j = j+1;
        			}//while loop
        		
        	}//promise outside
        ); 	
		
          
        });
      }
      

		//process the email feeds array
      function processData(emailFeed){
      	if(messageProcessed == 0){
	      	messageProcessed =1;
	      	alert("PROCESSDATA");
			//alert(emailFeed[0].date);
			var thisDate = new Date(emailFeed[0].date);
			emailFeed.sort(function(a,b){
				var aDate = new Date(a.date);
				var bDate = new Date(b.date);
				return bDate-aDate;			
			});	
      	}
      	
      	console.log(emailFeed);
      	alert("PROCESS DATA DONE");
      	createMessage(emailFeed, 5);
      }
      


		      
		function decode64(s) {
		    var e={},i,b=0,c,x,l=0,a,r='',w=String.fromCharCode,L=s.length;
		    var A="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";
		    for(i=0;i<64;i++){e[A.charAt(i)]=i;}
		    for(x=0;x<L;x++){
		        c=e[s.charAt(x)];b=(b<<6)+c;l+=6;
		        while(l>=8){((a=(b>>>(l-=8))&0xff)||(x<(L-2)))&&(r+=w(a));}
		    }
		    return r;
		};
		      
      	//create a message
        function createMessage(emailFeed, limit) {
        	document.getElementById("emailBody").innerHTML = emailFeed[0]['body'];
        	document.getElementById("emailTitle").innerHTML = emailFeed[0]['snippet'];
        	       	
  		}
    </script>
    <script src="https://apis.google.com/js/client.js?onload=handleClientLoad"></script>

</html>